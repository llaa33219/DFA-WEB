{% extends "base.html" %}

{% block title %}í˜¸ê°ë„ - DFA-Notation-Grammar{% endblock %}

{% block head %}
<!-- Live2D Cubism 2 Runtime (for older models like Shizuku) -->
<script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
<!-- Live2D Cubism 4 Core (for newer models) -->
<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<!-- PixiJS v6 (compatible with pixi-live2d-display) -->
<script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
<!-- pixi-live2d-display (Cubism 2 build for .moc models) -->
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/cubism2.min.js"></script>
<style>
    .affinity-page {
        display: flex;
        height: calc(100vh - 72px);
        position: relative;
    }

    .affinity-background {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 50%, #fda4af 100%);
        z-index: 1;
    }

    .avatar-container {
        position: relative;
        width: 500px;
        height: 580px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    #live2d-canvas {
        width: 500px;
        height: 580px;
        border-radius: var(--radius-lg);
        background: linear-gradient(180deg, #ffe4e6 0%, #fecdd3 100%);
        box-shadow: var(--shadow-lg);
        cursor: pointer;
    }

    .avatar-status {
        margin-top: var(--space-md);
        padding: var(--space-sm) var(--space-md);
        background: var(--white);
        border-radius: var(--radius-full);
        box-shadow: var(--shadow-sm);
        font-size: 14px;
        font-weight: 600;
        color: var(--gray-700);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        transition: all 0.3s ease;
    }

    .avatar-status .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
        animation: pulse-dot 2s ease infinite;
    }

    @keyframes pulse-dot {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }

    .avatar-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--gray-500);
    }

    .avatar-loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--gray-200);
        border-top-color: var(--error);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--space-sm);
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .avatar-badge {
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        color: var(--gray-400);
        white-space: nowrap;
        background: rgba(255,255,255,0.8);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
    }

    .avatar-badge a {
        color: var(--gray-500);
        text-decoration: none;
    }

    .avatar-badge a:hover {
        text-decoration: underline;
    }

    .affinity-display {
        position: fixed;
        top: 90px;
        right: var(--space-xl);
        background: var(--white);
        padding: var(--space-md) var(--space-xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        z-index: 100;
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }

    .affinity-label {
        font-size: 18px;
        font-weight: 600;
        color: var(--gray-700);
    }

    .affinity-score {
        font-size: 32px;
        font-weight: 800;
        color: var(--error);
        transition: all 0.3s ease;
    }

    .affinity-score.positive {
        color: var(--success);
    }

    .affinity-score.negative {
        color: var(--error);
    }

    .affinity-change {
        position: absolute;
        font-size: 24px;
        font-weight: 700;
        opacity: 0;
        pointer-events: none;
        right: 10px;
        top: -10px;
    }

    .affinity-change.show {
        animation: scoreChange 1s ease-out forwards;
    }

    .affinity-change.up {
        color: var(--success);
    }

    .affinity-change.down {
        color: var(--error);
    }

    @keyframes scoreChange {
        0% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-30px); }
    }

    .heart-effect {
        position: absolute;
        font-size: 32px;
        opacity: 0;
        pointer-events: none;
        top: 50%;
        left: 50%;
    }

    .heart-effect.show {
        animation: floatHeart 1.5s ease-out forwards;
    }

    @keyframes floatHeart {
        0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5); }
    }

    .chat-panel {
        position: relative;
        z-index: 10;
        width: 400px;
        margin: var(--space-lg);
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        margin-bottom: var(--space-md);
    }

    .chat-header h1 {
        font-size: 24px;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: var(--space-xs);
    }

    .chat-header p {
        font-size: 14px;
        color: var(--gray-600);
    }

    .chat-box {
        flex: 1;
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        overflow-y: auto;
        padding: var(--space-md);
        margin-bottom: var(--space-md);
    }

    .message {
        margin-bottom: var(--space-sm);
        display: flex;
        flex-direction: column;
    }

    .message.user {
        align-items: flex-end;
    }

    .message.assistant {
        align-items: flex-start;
    }

    .message-content {
        max-width: 90%;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-size: 14px;
        line-height: 1.5;
    }

    .message.user .message-content {
        background: var(--primary-500);
        color: var(--white);
    }

    .message.assistant .message-content {
        background: var(--gray-100);
        color: var(--gray-800);
    }

    .message-label {
        font-size: 11px;
        color: var(--gray-500);
        margin-bottom: 2px;
    }

    .input-area {
        display: flex;
        gap: var(--space-sm);
    }

    .input-area .input {
        flex: 1;
        padding: 10px 14px;
        font-size: 14px;
    }

    .input-area .btn {
        padding: 10px 16px;
        font-size: 14px;
    }

    .loading {
        display: none;
        text-align: center;
        padding: var(--space-sm);
        color: var(--gray-500);
        font-size: 14px;
    }

    .loading.show {
        display: block;
    }

    .action-content {
        color: var(--gray-500);
        font-style: italic;
    }

    .action-name {
        color: var(--error);
        font-weight: 600;
        margin-right: 4px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        color: var(--gray-600);
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: var(--space-sm);
    }

    .back-link:hover {
        color: var(--primary-500);
    }

    @media (max-width: 768px) {
        .affinity-page {
            flex-direction: column;
        }

        .chat-panel {
            width: 100%;
            margin: var(--space-md);
        }

        .affinity-background {
            position: relative;
            height: 350px;
        }

        .avatar-container {
            width: 280px;
            height: 320px;
        }

        #live2d-canvas {
            width: 280px;
            height: 300px;
        }

        .affinity-display {
            top: 80px;
            right: var(--space-md);
            padding: var(--space-sm) var(--space-md);
        }

        .affinity-score {
            font-size: 24px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="affinity-display">
    <span class="affinity-label">â¤ï¸ í˜¸ê°ë„:</span>
    <span class="affinity-score" id="affinityScore">50</span>
    <span class="affinity-change" id="affinityChange"></span>
</div>

<div class="affinity-page">
    <div class="affinity-background">
        <div class="avatar-container">
            <canvas id="live2d-canvas" width="500" height="580"></canvas>
            <div class="avatar-loading" id="avatarLoading">
                <div class="avatar-loading-spinner"></div>
                <div>Live2D ëª¨ë¸ ë¡œë”© ì¤‘...</div>
            </div>
            <div class="heart-effect" id="heartEffect">â¤ï¸</div>
            <div class="avatar-status">
                <span class="status-dot"></span>
                <span id="avatarStatusText">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="avatar-badge">Powered by <a href="https://www.live2d.com/" target="_blank">Live2D</a></div>
        </div>
    </div>

    <div class="chat-panel">
        <a href="/" class="back-link">â† ëŒì•„ê°€ê¸°</a>
        
        <div class="chat-header">
            <h1>â¤ï¸ í˜¸ê°ë„ ì˜ˆì‹œ</h1>
            <p>ëŒ€í™”ì— ë”°ë¼ í˜¸ê°ë„ê°€ ì˜¬ë¼ê°€ê±°ë‚˜ ë‚´ë ¤ê°‘ë‹ˆë‹¤</p>
        </div>

        <div class="chat-box" id="chatBox">
            <div class="message assistant">
                <span class="message-label">AI</span>
                <div class="message-content">
                    ì•ˆë…•í•˜ì„¸ìš”! ì¬ë¯¸ìˆê²Œ ëŒ€í™”í•˜ê³  ì‹¶ì–´ìš”
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <span>ì‘ë‹µ ìƒì„± ì¤‘...</span>
        </div>

        <div class="input-area">
            <input type="text" class="input" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
            <button class="btn btn-primary" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatBox = document.getElementById('chatBox');
    const messageInput = document.getElementById('messageInput');
    const loading = document.getElementById('loading');
    const heartEffect = document.getElementById('heartEffect');
    const affinityScoreEl = document.getElementById('affinityScore');
    const affinityChangeEl = document.getElementById('affinityChange');
    const avatarStatusText = document.getElementById('avatarStatusText');
    const avatarLoading = document.getElementById('avatarLoading');
    
    let conversationHistory = [];
    let affinityScore = 50;
    let live2dModel = null;
    let pixiApp = null;

    // í˜¸ê°ë„ ì•¡ì…˜ì— ë”°ë¥¸ ëª¨ì…˜ ë§¤í•‘
    // point_up -> happy (Success.mtn)
    // point_down -> sad (Fail.mtn)
    const actionToMotion = {
        'point_up': { group: 'happy', status: 'í˜¸ê°ë„ ìƒìŠ¹! ğŸ’•' },
        'point_down': { group: 'sad', status: 'í˜¸ê°ë„ í•˜ë½... ğŸ’”' }
    };

    const MODEL_URLS = {
        local: '/static/models/pio/index.json',
        cdn: 'https://cdn.jsdelivr.net/npm/live2d-widget-model@1.0.1/model/Potion-Maker/Pio/model.json'
    };

    async function loadModelWithRetry(url, retries = 2, delay = 1000) {
        for (let i = 0; i <= retries; i++) {
            try {
                const model = await PIXI.live2d.Live2DModel.from(url);
                return model;
            } catch (error) {
                console.warn(`Model load attempt ${i + 1} failed for ${url}:`, error.message);
                if (i < retries) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    throw error;
                }
            }
        }
    }

    function setupModel(model) {
        model.scale.set(1);
        model.anchor.set(0.5, 0.5);
        model.x = pixiApp.screen.width / 2;
        model.y = pixiApp.screen.height / 2 + 50;
        model.interactive = true;
        model.buttonMode = true;

        model.on('pointerdown', (e) => {
            const point = e.data.global;
            model.tap(point.x, point.y);
        });

        model.on('pointermove', (e) => {
            const point = e.data.global;
            model.focus(point.x, point.y);
        });

        return model;
    }

    async function initLive2D() {
        const canvas = document.getElementById('live2d-canvas');
        
        pixiApp = new PIXI.Application({
            view: canvas,
            autoStart: true,
            backgroundAlpha: 0,
            width: 500,
            height: 580
        });

        // Try local files first
        try {
            avatarLoading.querySelector('div:last-child').textContent = 'ë¡œì»¬ ëª¨ë¸ ë¡œë”© ì¤‘...';
            live2dModel = await loadModelWithRetry(MODEL_URLS.local, 1, 500);
            setupModel(live2dModel);
            pixiApp.stage.addChild(live2dModel);
            avatarLoading.style.display = 'none';
            console.log('Live2D model loaded from local files!');
            return;
        } catch (localError) {
            console.warn('Local model failed, trying CDN fallback...', localError.message);
        }

        // Fallback to CDN
        try {
            avatarLoading.querySelector('div:last-child').textContent = 'CDNì—ì„œ ëª¨ë¸ ë¡œë”© ì¤‘...';
            live2dModel = await loadModelWithRetry(MODEL_URLS.cdn, 2, 1500);
            setupModel(live2dModel);
            pixiApp.stage.addChild(live2dModel);
            avatarLoading.style.display = 'none';
            console.log('Live2D model loaded from CDN!');
            return;
        } catch (cdnError) {
            console.error('All model sources failed:', cdnError);
            avatarLoading.innerHTML = `
                <div style="color: var(--error); font-weight: 600;">Live2D ë¡œë”© ì‹¤íŒ¨</div>
                <div style="font-size: 12px; margin-top: 8px; color: var(--gray-600);">
                    ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜<br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”
                </div>
                <button onclick="location.reload()" style="
                    margin-top: 12px;
                    padding: 8px 16px;
                    background: var(--error);
                    color: white;
                    border: none;
                    border-radius: var(--radius-md);
                    cursor: pointer;
                    font-size: 13px;
                ">ìƒˆë¡œê³ ì¹¨</button>
            `;
        }
    }

    function triggerLive2DAction(actionName) {
        if (!live2dModel) return;
        
        const motionConfig = actionToMotion[actionName];
        if (!motionConfig) return;
        
        const group = motionConfig.group;
        
        try {
            live2dModel.motion(group, undefined, PIXI.live2d.MotionPriority.FORCE);
            avatarStatusText.textContent = motionConfig.status;
        } catch (e) {
            console.warn('Motion failed:', e);
        }
    }

    function resetToIdle() {
        if (!live2dModel) return;
        avatarStatusText.textContent = 'ëŒ€ê¸° ì¤‘';
        // idle ëª¨ì…˜ì€ ìë™ìœ¼ë¡œ ì¬ìƒë¨
    }

    document.addEventListener('DOMContentLoaded', initLive2D);

    window.addEventListener('beforeunload', () => {
        if (pixiApp) {
            pixiApp.destroy(true, { children: true, texture: true, baseTexture: true });
        }
    });

    function handleKeyPress(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    }

    function updateAffinity(change, actionName) {
        affinityScore = Math.max(0, Math.min(100, affinityScore + change));
        
        // Show change animation
        affinityChangeEl.textContent = change > 0 ? `+${change}` : change;
        affinityChangeEl.className = `affinity-change show ${change > 0 ? 'up' : 'down'}`;
        
        setTimeout(() => {
            affinityChangeEl.className = 'affinity-change';
        }, 1000);

        // Update score display
        affinityScoreEl.textContent = affinityScore;
        affinityScoreEl.className = `affinity-score ${affinityScore >= 50 ? 'positive' : 'negative'}`;

        // Trigger Live2D motion based on action
        if (actionName) {
            triggerLive2DAction(actionName);
        }

        // Show heart effect for positive changes
        if (change > 0) {
            heartEffect.className = 'heart-effect show';
            setTimeout(() => {
                heartEffect.className = 'heart-effect';
            }, 1500);
        }

        // Reset to idle after delay
        setTimeout(() => {
            resetToIdle();
        }, 2500);
    }

    function addMessage(role, content, rendered = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const label = document.createElement('span');
        label.className = 'message-label';
        label.textContent = role === 'user' ? 'ë‚˜' : 'AI';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (rendered) {
            contentDiv.innerHTML = rendered;
        } else {
            contentDiv.textContent = content;
        }
        
        messageDiv.appendChild(label);
        messageDiv.appendChild(contentDiv);
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function processAffinityActions(actions) {
        if (actions && actions.length > 0) {
            let totalChange = 0;
            let lastAction = null;
            
            actions.forEach(action => {
                if (action.action === 'point_up') {
                    totalChange += 1;
                    lastAction = 'point_up';
                } else if (action.action === 'point_down') {
                    totalChange -= 1;
                    lastAction = 'point_down';
                }
            });
            
            if (totalChange !== 0) {
                updateAffinity(totalChange, lastAction);
            }
        }
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        messageInput.value = '';
        addMessage('user', message);
        conversationHistory.push({ role: 'user', content: message });

        loading.classList.add('show');

        avatarStatusText.textContent = 'ìƒê°í•˜ëŠ” ì¤‘...';
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    example_type: 'affinity',
                    history: conversationHistory
                })
            });

            const data = await response.json();

            if (data.error) {
                if (data.redirect) {
                    window.location.href = data.redirect;
                    return;
                }
                addMessage('assistant', 'ì˜¤ë¥˜: ' + data.error);
            } else {
                addMessage('assistant', data.response, data.rendered);
                conversationHistory.push({ role: 'assistant', content: data.response });
                processAffinityActions(data.actions);
            }
        } catch (error) {
            addMessage('assistant', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        } finally {
            loading.classList.remove('show');
        }
    }
</script>
{% endblock %}
